# --- COLADUINO COMPILER UPLOAD SCRIPT V1.0 ---
# Importowanie niezbƒôdnych bibliotek
!pip install PyGithub --quiet
from github import Github
from google.colab import drive, files
from google.colab import output
import base64
import os

# -------------------------------------------------------------
# KONFIGURACJA GITHUB
# -------------------------------------------------------------
REPO_NAME = "Kosior3x/Coladuino-Compiler-ESP-Arduino"
BRANCH_NAME = "main"  # Upewnij siƒô, ≈ºe to jest w≈Ça≈õciwa nazwa ga≈Çƒôzi (czƒôsto 'main')
SOURCE_FILE_PATH = "firmware.bin" # Nazwa skompilowanego pliku BIN (lokalnie w Colab)
TARGET_GITHUB_PATH = "compiled_firmwares/firmware.bin" # ≈öcie≈ºka w repozytorium GitHub
COMMIT_MESSAGE = "Automatyczna kompilacja Coladuino i upload pliku BIN."
# -------------------------------------------------------------

# Wy≈õwietlenie okna modalnego do bezpiecznego wklejenia tokenu
print("--- üîë Autoryzacja GitHub ---")
print("Wklej sw√≥j osobisty Token Dostƒôpu GitHub (musi mieƒá uprawnienie 'repo').")
github_token = input("Wklej token: ")
output.clear() # Czy≈õci poprzednie linie, aby token nie zosta≈Ç w historii

if not github_token:
    print("‚ùå Token nie zosta≈Ç wklejony. Wgranie pliku niemo≈ºliwe.")
else:
    if not os.path.exists(SOURCE_FILE_PATH):
        print(f"‚ùå B≈ÇƒÖd: Nie znaleziono skompilowanego pliku BIN pod ≈õcie≈ºkƒÖ '{SOURCE_FILE_PATH}'. Upewnij siƒô, ≈ºe kompilacja siƒô powiod≈Ça.")
    else:
        try:
            g = Github(github_token)
            repo = g.get_repo(REPO_NAME)
            
            # Wczytanie zawarto≈õci pliku w trybie binarnym
            with open(SOURCE_FILE_PATH, 'rb') as file:
                content_bytes = file.read()
            
            # Kodowanie tre≈õci do Base64, poniewa≈º GitHub API wymaga Base64
            content_b64 = base64.b64encode(content_bytes).decode('utf-8')
            
            print(f"\n‚úÖ Po≈ÇƒÖczenie z repozytorium {REPO_NAME} nawiƒÖzane.")

            # Sprawdzenie, czy plik ju≈º istnieje (aby go zaktualizowaƒá)
            try:
                # Pobranie istniejƒÖcego pliku, aby uzyskaƒá jego SHA (wymagane do aktualizacji)
                file_data = repo.get_contents(TARGET_GITHUB_PATH, ref=BRANCH_NAME)
                
                # Aktualizacja istniejƒÖcego pliku
                repo.update_file(
                    TARGET_GITHUB_PATH, 
                    COMMIT_MESSAGE, 
                    content_b64, 
                    file_data.sha, 
                    branch=BRANCH_NAME
                )
                print(f"üîÑ ZAKTUALIZOWANO plik: {TARGET_GITHUB_PATH}")

            except Exception as e:
                # Je≈õli plik nie istnieje (B≈ÇƒÖd 404), utw√≥rz nowy
                if "404" in str(e):
                    repo.create_file(
                        TARGET_GITHUB_PATH, 
                        COMMIT_MESSAGE, 
                        content_b64, 
                        branch=BRANCH_NAME
                    )
                    print(f"üÜï UTWORZONO nowy plik: {TARGET_GITHUB_PATH}")
                else:
                     raise # Wyrzucenie innego b≈Çƒôdu

            print(f"--- GOTOWE ---")
            print(f"Sprawd≈∫ zmiany tutaj: https://github.com/{REPO_NAME}/blob/{BRANCH_NAME}/{TARGET_GITHUB_PATH}")
            print(f"Commit: {COMMIT_MESSAGE}")

        except Exception as e:
            print(f"\n‚ùå Krytyczny B≈ÇƒÖd podczas operacji GitHub: {e}")
            print("Sprawd≈∫, czy TOKEN jest poprawny i czy ma uprawnienie 'repo'.")
